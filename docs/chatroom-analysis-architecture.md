# Chatroom Messages Analysis æ¶æ„æ–‡æ¡£

æœ¬æ–‡æ¡£æè¿° diting é¡¹ç›®ä¸­ç¾¤èŠæ¶ˆæ¯åˆ†æç³»ç»Ÿçš„æ•´ä½“æ¶æ„ã€å¤„ç†æµç¨‹å’Œå¯æ‰©å±•ç‚¹ã€‚

## 1. ç³»ç»Ÿæ¶æ„æ¦‚è§ˆ

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                              CLI Layer (cli.py)                             â”‚
â”‚                    analyze-chatrooms -d YYYY-MM-DD                          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                      â”‚
                                      â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    Analysis Orchestrator (analysis.py)                      â”‚
â”‚                      ChatroomMessageAnalyzer                                â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚  åè°ƒå„å­æ¨¡å—å®Œæˆ: æ•°æ®åŠ è½½ â†’ å¢å¼º â†’ æ‰¹å¤„ç† â†’ LLMè°ƒç”¨ â†’ åˆå¹¶ â†’ æ‘˜è¦  â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                      â”‚
          â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
          â–¼                           â–¼                           â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   Data Layer        â”‚   â”‚   Processing Layer  â”‚   â”‚   Output Layer      â”‚
â”‚                     â”‚   â”‚                     â”‚   â”‚                     â”‚
â”‚ â€¢ Parquet Storage   â”‚   â”‚ â€¢ Message Enricher  â”‚   â”‚ â€¢ Debug Writer      â”‚
â”‚ â€¢ DuckDB Query      â”‚   â”‚ â€¢ Message Formatter â”‚   â”‚ â€¢ Report Generator  â”‚
â”‚ â€¢ Time Utils        â”‚   â”‚ â€¢ Message Batcher   â”‚   â”‚ â€¢ Markdown Output   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚ â€¢ LLM Client        â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                          â”‚ â€¢ Response Parser   â”‚
                          â”‚ â€¢ Topic Merger      â”‚
                          â”‚ â€¢ Topic Summarizer  â”‚
                          â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## 2. è¯¦ç»†å¤„ç†æµç¨‹

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                           æ¶ˆæ¯åˆ†æå¤„ç†æµç¨‹                                    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚  Parquet    â”‚  data/messages/parquet/
    â”‚  Storage    â”‚  æŒ‰æ—¥æœŸåˆ†åŒºå­˜å‚¨
    â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜
           â”‚ query_messages()
           â–¼
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚  Message    â”‚  è§£æ msg_type=49 çš„ XML
    â”‚  Enricher   â”‚  æå–å¼•ç”¨æ¶ˆæ¯ (refermsg)
    â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜
           â”‚ enrich_messages_batch()
           â–¼
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚  Message    â”‚  æ ¼å¼åŒ–ä¸º LLM å¯è¯»æ–‡æœ¬
    â”‚  Formatter  â”‚  [msg_id] HH:MM sender: content
    â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜
           â”‚ format_messages()
           â–¼
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚  Message    â”‚  æŒ‰ token ä¼°ç®—åˆ‡åˆ†
    â”‚  Batcher    â”‚  é¿å…è¶…é•¿è¾“å…¥
    â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜
           â”‚ create_batches()
           â–¼
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚  LLM        â”‚  è°ƒç”¨ OpenAI API
    â”‚  Client     â”‚  ä½¿ç”¨ LangChain
    â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜
           â”‚ invoke()
           â–¼
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚  Response   â”‚  è§£æåˆ†éš”ç¬¦åè®®
    â”‚  Parser     â”‚  <<<TOPIC>>> æ ¼å¼
    â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜
           â”‚ parse_response()
           â–¼
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚  Topic      â”‚  å…³é”®è¯ç›¸ä¼¼åº¦åˆå¹¶
    â”‚  Merger     â”‚  Protocol + Strategy
    â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜
           â”‚ merge_topics()
           â–¼
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚  Topic      â”‚  äºŒæ¬¡æ‘˜è¦ç”Ÿæˆ
    â”‚  Summarizer â”‚  title/category/summary
    â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜
           â”‚ summarize_topics()
           â–¼
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚  Report     â”‚  Markdown æ ¼å¼
    â”‚  Generator  â”‚  çƒ­é—¨åº¦æ’åº Top 10
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## 3. æ¨¡å—èŒè´£è¯´æ˜

| æ¨¡å— | æ–‡ä»¶ | èŒè´£ |
|------|------|------|
| **time_utils** | `time_utils.py` | æ—¶é—´å¤„ç†ã€æ—¥æœŸèŒƒå›´æ„å»ºã€æ—¶åŒºè½¬æ¢ |
| **debug_writer** | `debug_writer.py` | è°ƒè¯•è¾“å‡ºã€æ‰¹æ¬¡æ—¥å¿—ã€åˆå¹¶æŠ¥å‘Š |
| **message_formatter** | `message_formatter.py` | æ¶ˆæ¯æ ¼å¼åŒ–ã€åºå·åˆ†é…ã€OCR ç¼“å­˜åŠ è½½ |
| **message_batcher** | `message_batcher.py` | Token ä¼°ç®—ã€æ‰¹æ¬¡åˆ‡åˆ†ã€å¤§å°æ§åˆ¶ |
| **message_enricher** | `message_enricher.py` | XML è§£æã€å¼•ç”¨æ¶ˆæ¯æå–ã€å­—æ®µå¢å¼º |
| **llm_client** | `llm_client.py` | LangChain å°è£…ã€API è°ƒç”¨ã€é‡è¯•é€»è¾‘ |
| **response_parser** | `response_parser.py` | åè®®è§£æã€è¯é¢˜æå–ã€é”™è¯¯å¤„ç† |
| **topic_merger** | `topic_merger.py` | å…³é”®è¯ç›¸ä¼¼åº¦ã€åˆå¹¶ç­–ç•¥ã€Protocol å®šä¹‰ |
| **topic_summarizer** | `topic_summarizer.py` | äºŒæ¬¡æ‘˜è¦ã€åˆ†æ®µåˆå¹¶ã€æœ€ç»ˆè¾“å‡º |
| **prompts** | `prompts.py` | æç¤ºè¯æ¨¡æ¿ã€ç³»ç»Ÿ/ç”¨æˆ· prompt |
| **config** | `config.py` | é…ç½®åŠ è½½ã€å‚æ•°éªŒè¯ã€é»˜è®¤å€¼ |

## 4. å¯æ‰©å±•ç‚¹æ ‡è¯†

### 4.1 ç­–ç•¥æ‰©å±•ç‚¹ (Strategy Pattern)

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                         ğŸ”Œ EXTENSION POINT #1                               â”‚
â”‚                         Topic Merge Strategy                                â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  æ–‡ä»¶: src/services/llm/topic_merger.py                                     â”‚
â”‚  æ¥å£: MergeStrategy (Protocol)                                             â”‚
â”‚                                                                             â”‚
â”‚  class MergeStrategy(Protocol):                                             â”‚
â”‚      def should_merge(self, topic1, topic2) -> bool: ...                    â”‚
â”‚                                                                             â”‚
â”‚  å½“å‰å®ç°:                                                                   â”‚
â”‚  â€¢ KeywordSimilarityStrategy - åŸºäºå…³é”®è¯ç›¸ä¼¼åº¦ (é»˜è®¤)                       â”‚
â”‚                                                                             â”‚
â”‚  æ‰©å±•æ–¹å‘:                                                                   â”‚
â”‚  â€¢ SemanticEmbeddingStrategy - åŸºäºè¯­ä¹‰å‘é‡ç›¸ä¼¼åº¦                            â”‚
â”‚  â€¢ TimeProximityStrategy - åŸºäºæ—¶é—´é‚»è¿‘æ€§                                    â”‚
â”‚  â€¢ HybridStrategy - å¤šå› ç´ åŠ æƒç»„åˆ                                           â”‚
â”‚  â€¢ LLMBasedStrategy - ä½¿ç”¨ LLM åˆ¤æ–­æ˜¯å¦åˆå¹¶                                  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 4.2 æ¶ˆæ¯å¢å¼ºæ‰©å±•ç‚¹

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                         ğŸ”Œ EXTENSION POINT #2                               â”‚
â”‚                         Message Enricher Pipeline                           â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  æ–‡ä»¶: src/services/llm/message_enricher.py                                 â”‚
â”‚  å½“å‰åŠŸèƒ½: XML è§£æã€å¼•ç”¨æ¶ˆæ¯æå–                                            â”‚
â”‚                                                                             â”‚
â”‚  æ‰©å±•æ–¹å‘:                                                                   â”‚
â”‚  â€¢ è¡¨æƒ…åŒ…è¯†åˆ«ä¸æè¿°                                                          â”‚
â”‚  â€¢ é“¾æ¥é¢„è§ˆæå– (URL â†’ æ ‡é¢˜/æ‘˜è¦)                                            â”‚
â”‚  â€¢ æ–‡ä»¶ç±»å‹è¯†åˆ« (æ–‡æ¡£/è§†é¢‘/éŸ³é¢‘)                                             â”‚
â”‚  â€¢ å°ç¨‹åºå¡ç‰‡è§£æ                                                            â”‚
â”‚  â€¢ ä½ç½®æ¶ˆæ¯è§£æ                                                              â”‚
â”‚  â€¢ è¯­éŸ³è½¬æ–‡å­— (ASR)                                                          â”‚
â”‚                                                                             â”‚
â”‚  å»ºè®®: é‡‡ç”¨ Pipeline æ¨¡å¼ï¼Œæ”¯æŒé“¾å¼å¢å¼ºå™¨                                    â”‚
â”‚  class EnricherPipeline:                                                    â”‚
â”‚      def add_enricher(self, enricher: MessageEnricher) -> Self              â”‚
â”‚      def process(self, messages) -> list[dict]                              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 4.3 LLM æä¾›å•†æ‰©å±•ç‚¹

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                         ğŸ”Œ EXTENSION POINT #3                               â”‚
â”‚                         LLM Provider Abstraction                            â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  æ–‡ä»¶: src/services/llm/llm_client.py                                       â”‚
â”‚  å½“å‰å®ç°: LangChain + OpenAI                                               â”‚
â”‚                                                                             â”‚
â”‚  æ‰©å±•æ–¹å‘:                                                                   â”‚
â”‚  â€¢ Claude (Anthropic) æ”¯æŒ                                                  â”‚
â”‚  â€¢ æœ¬åœ°æ¨¡å‹ (Ollama/vLLM)                                                   â”‚
â”‚  â€¢ Azure OpenAI                                                             â”‚
â”‚  â€¢ å¤šæ¨¡å‹è·¯ç”± (æˆæœ¬/è´¨é‡æƒè¡¡)                                                â”‚
â”‚                                                                             â”‚
â”‚  å»ºè®®: å®šä¹‰ LLMProvider Protocol                                            â”‚
â”‚  class LLMProvider(Protocol):                                               â”‚
â”‚      async def complete(self, prompt: str) -> str: ...                      â”‚
â”‚      def estimate_tokens(self, text: str) -> int: ...                       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 4.4 è¾“å‡ºæ ¼å¼æ‰©å±•ç‚¹

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                         ğŸ”Œ EXTENSION POINT #4                               â”‚
â”‚                         Report Output Format                                â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  æ–‡ä»¶: cli.py (æŠ¥å‘Šç”Ÿæˆéƒ¨åˆ†)                                                 â”‚
â”‚  å½“å‰å®ç°: Markdown æ ¼å¼                                                     â”‚
â”‚                                                                             â”‚
â”‚  æ‰©å±•æ–¹å‘:                                                                   â”‚
â”‚  â€¢ HTML æŠ¥å‘Š (å¸¦æ ·å¼)                                                        â”‚
â”‚  â€¢ JSON ç»“æ„åŒ–è¾“å‡º                                                           â”‚
â”‚  â€¢ PDF å¯¼å‡º                                                                  â”‚
â”‚  â€¢ é‚®ä»¶æ¨¡æ¿                                                                  â”‚
â”‚  â€¢ å¾®ä¿¡æ¶ˆæ¯å¡ç‰‡æ ¼å¼                                                          â”‚
â”‚  â€¢ Slack/é£ä¹¦ é€šçŸ¥æ ¼å¼                                                       â”‚
â”‚                                                                             â”‚
â”‚  å»ºè®®: å®šä¹‰ ReportRenderer Protocol                                         â”‚
â”‚  class ReportRenderer(Protocol):                                            â”‚
â”‚      def render(self, result: ChatroomAnalysisResult) -> str: ...           â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 4.5 å­˜å‚¨åç«¯æ‰©å±•ç‚¹

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                         ğŸ”Œ EXTENSION POINT #5                               â”‚
â”‚                         Storage Backend                                     â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  æ–‡ä»¶: src/services/storage/                                                â”‚
â”‚  å½“å‰å®ç°: Parquet + DuckDB                                                 â”‚
â”‚                                                                             â”‚
â”‚  æ‰©å±•æ–¹å‘:                                                                   â”‚
â”‚  â€¢ PostgreSQL (ç”Ÿäº§ç¯å¢ƒ)                                                     â”‚
â”‚  â€¢ ClickHouse (å¤§è§„æ¨¡åˆ†æ)                                                   â”‚
â”‚  â€¢ Elasticsearch (å…¨æ–‡æœç´¢)                                                  â”‚
â”‚  â€¢ S3/OSS (äº‘å­˜å‚¨)                                                           â”‚
â”‚                                                                             â”‚
â”‚  å»ºè®®: å®šä¹‰ MessageRepository Protocol                                      â”‚
â”‚  class MessageRepository(Protocol):                                         â”‚
â”‚      def query(self, date_range, filters) -> list[Message]: ...             â”‚
â”‚      def save(self, messages: list[Message]) -> None: ...                   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 4.6 æç¤ºè¯ç‰ˆæœ¬æ‰©å±•ç‚¹

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                         ğŸ”Œ EXTENSION POINT #6                               â”‚
â”‚                         Prompt Template Versioning                          â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  æ–‡ä»¶: src/services/llm/prompts.py                                          â”‚
â”‚  å½“å‰å®ç°: v1/v2 ç¡¬ç¼–ç åˆ‡æ¢                                                  â”‚
â”‚                                                                             â”‚
â”‚  æ‰©å±•æ–¹å‘:                                                                   â”‚
â”‚  â€¢ æç¤ºè¯ A/B æµ‹è¯•æ¡†æ¶                                                       â”‚
â”‚  â€¢ åŠ¨æ€æç¤ºè¯åŠ è½½ (ä»é…ç½®/æ•°æ®åº“)                                            â”‚
â”‚  â€¢ å¤šè¯­è¨€æç¤ºè¯æ”¯æŒ                                                          â”‚
â”‚  â€¢ æç¤ºè¯æ•ˆæœè¯„ä¼°ä¸è‡ªåŠ¨ä¼˜åŒ–                                                  â”‚
â”‚                                                                             â”‚
â”‚  å»ºè®®: å®šä¹‰ PromptTemplate Protocol                                         â”‚
â”‚  class PromptTemplate(Protocol):                                            â”‚
â”‚      def get_system_prompt(self) -> str: ...                                â”‚
â”‚      def get_user_prompt(self, messages: str) -> str: ...                   â”‚
â”‚      def get_version(self) -> str: ...                                      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## 5. æ‰©å±•ç‚¹ä¼˜å…ˆçº§å»ºè®®

| ä¼˜å…ˆçº§ | æ‰©å±•ç‚¹ | ç†ç”± |
|--------|--------|------|
| ğŸ”´ é«˜ | #2 Message Enricher Pipeline | æ”¯æŒæ›´å¤šæ¶ˆæ¯ç±»å‹æ˜¯æ ¸å¿ƒéœ€æ±‚ |
| ğŸ”´ é«˜ | #3 LLM Provider | é™ä½æˆæœ¬ã€æé«˜å¯ç”¨æ€§ |
| ğŸŸ¡ ä¸­ | #1 Merge Strategy | æå‡è¯é¢˜èšåˆå‡†ç¡®æ€§ |
| ğŸŸ¡ ä¸­ | #4 Report Format | æ”¯æŒæ›´å¤šè¾“å‡ºæ¸ é“ |
| ğŸŸ¢ ä½ | #5 Storage Backend | å½“å‰ Parquet å·²æ»¡è¶³éœ€æ±‚ |
| ğŸŸ¢ ä½ | #6 Prompt Versioning | å¾…æç¤ºè¯ç¨³å®šåå†è€ƒè™‘ |

## 6. é…ç½®æ–‡ä»¶

```yaml
# config/llm.yaml
analysis:
  max_messages_per_batch: null      # æ¯æ‰¹æœ€å¤§æ¶ˆæ¯æ•°
  max_content_length: null          # å†…å®¹æœ€å¤§é•¿åº¦
  enable_xml_parsing: true          # å¯ç”¨ XML è§£æ
  enable_refermsg_display: true     # æ˜¾ç¤ºå¼•ç”¨æ¶ˆæ¯
  prompt_version: "v2"              # æç¤ºè¯ç‰ˆæœ¬
  timezone: "Asia/Shanghai"         # æ—¶åŒºè®¾ç½®
  merge_threshold: 0.5              # åˆå¹¶é˜ˆå€¼
```

## 7. ç›¸å…³æ–‡æ¡£

- [å¾®ä¿¡ç¾¤èŠæ¶ˆæ¯æ€»ç»“æµç¨‹](./wechat-analysis-workflow.md) - è¯¦ç»†æµç¨‹è¯´æ˜
- [LLM åˆ†ææç¤ºè¯ä¼˜åŒ–æ–¹æ¡ˆ](./llm-analysis-refermsg-optimization.md) - å¼•ç”¨æ¶ˆæ¯æ”¯æŒ
- [å¾®ä¿¡æ¶ˆæ¯ Schema](./wechat-message-schema.md) - æ¶ˆæ¯å­—æ®µå®šä¹‰
