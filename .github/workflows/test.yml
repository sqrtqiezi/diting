name: Test

# 触发条件: PR 验证 + master 分支保护
# 避免重复执行: 功能分支只在 PR 时运行,master 分支在 push 时运行
on:
  pull_request:
    types: [opened, synchronize, reopened]
  push:
    branches: [master]  # 仅 master 分支 push 时运行

# 权限配置
permissions:
  contents: read
  pull-requests: write  # 用于发布测试报告评论(可选)

jobs:
  test:
    runs-on: ubuntu-latest
    timeout-minutes: 10  # 超时保护

    steps:
      # Step 1: 检出代码
      - name: Checkout code
        uses: actions/checkout@v4

      # Step 2: 设置 Python 和 uv
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.12'

      - name: Install uv
        uses: astral-sh/setup-uv@v3
        with:
          enable-cache: true
          cache-dependency-glob: "uv.lock"

      # Step 3: 安装依赖
      - name: Install dependencies
        run: uv sync --frozen --extra dev

      # Step 4: 代码质量检查
      - name: Run ruff linter
        run: uv run ruff check .
        continue-on-error: false  # 失败时中断流程

      - name: Run ruff formatter check
        run: uv run ruff format --check .
        continue-on-error: false

      # Step 5: 类型检查
      - name: Run mypy type checker
        run: uv run mypy src/lib src/models src/services
        continue-on-error: false

      # Step 6: 运行测试套件
      - name: Run pytest with coverage
        run: |
          echo "::group::运行 pytest 测试套件"
          uv run pytest \
            --cov=src \
            --cov-report=term-missing \
            --cov-report=xml \
            --cov-fail-under=67 \
            -v
          echo "::endgroup::"

      # Step 7: 上传覆盖率报告(可选,用于 Codecov 等服务)
      - name: Upload coverage report
        uses: actions/upload-artifact@v4
        if: always()  # 即使测试失败也上传
        with:
          name: coverage-report
          path: coverage.xml
          retention-days: 30

      # Step 8: 发布测试结果评论到 PR(可选)
      - name: Comment test results on PR
        if: github.event_name == 'pull_request' && failure()
        uses: actions/github-script@v7
        with:
          script: |
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: '❌ **测试失败**: 请查看 [Actions 日志](' + context.payload.repository.html_url + '/actions/runs/' + context.runId + ') 了解详情。'
            })

# 预期结果:
# ✅ 成功: 所有检查通过,PR 显示绿色勾选
# ❌ 失败: 任何检查失败,PR 被阻止合并,显示具体错误
# ⏱️ 预期时间: 2-4 分钟
