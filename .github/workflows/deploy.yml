name: Deploy to Aliyun ECS

# è§¦å‘æ¡ä»¶: ä»… master åˆ†æ”¯çš„ push äº‹ä»¶
on:
  push:
    branches: [master]

# æƒé™é…ç½®
permissions:
  contents: read
  issues: write  # ç”¨äºåˆ›å»ºå¤±è´¥é€šçŸ¥ Issue

# ä¸²è¡Œæ‰§è¡Œéƒ¨ç½²(é˜²æ­¢å¹¶å‘å†²çª)
concurrency:
  group: production-deploy
  cancel-in-progress: false

jobs:
  deploy:
    runs-on: ubuntu-latest
    timeout-minutes: 15  # è¶…æ—¶ä¿æŠ¤
    # environment:  # æš‚æ—¶æ³¨é‡Šï¼Œä½¿ç”¨ Repository Secrets
    #   name: production
    #   url: http://${{ secrets.ALIYUN_ECS_HOST }}:8000

    steps:
      # Step 1: æ£€å‡ºä»£ç 
      - name: Checkout code
        uses: actions/checkout@v4

      # Step 2: é…ç½® SSH å¯†é’¥
      - name: Setup SSH key
        uses: webfactory/ssh-agent@v0.9.0
        with:
          ssh-private-key: ${{ secrets.ALIYUN_SSH_PRIVATE_KEY }}

      # Step 3: æ·»åŠ  ECS åˆ° known_hosts(é˜²æ­¢ä¸­é—´äººæ”»å‡»)
      - name: Add ECS to known hosts
        run: |
          mkdir -p ~/.ssh
          ssh-keyscan -H ${{ secrets.ALIYUN_ECS_HOST }} >> ~/.ssh/known_hosts

      # Step 4: åˆ›å»ºéƒ¨ç½²ç‰ˆæœ¬ç›®å½•
      - name: Create release directory
        id: create-release
        run: |
          RELEASE_ID=$(date +%s)
          RELEASE_DIR="/opt/diting/releases/$RELEASE_ID"
          echo "RELEASE_ID=$RELEASE_ID" >> $GITHUB_OUTPUT
          echo "RELEASE_DIR=$RELEASE_DIR" >> $GITHUB_OUTPUT

          ssh ${{ secrets.ALIYUN_SSH_USER }}@${{ secrets.ALIYUN_ECS_HOST }} \
            "mkdir -p $RELEASE_DIR"

          echo "âœ… åˆ›å»ºç‰ˆæœ¬ç›®å½•: $RELEASE_DIR"

      # Step 5: ä¸Šä¼ ä»£ç åˆ° ECS
      - name: Upload code to ECS
        run: |
          rsync -avz \
            --exclude='.git' \
            --exclude='.venv' \
            --exclude='__pycache__' \
            --exclude='*.pyc' \
            --exclude='.pytest_cache' \
            --exclude='.ruff_cache' \
            --exclude='.mypy_cache' \
            --exclude='coverage.xml' \
            --exclude='.coverage' \
            --exclude='logs/' \
            ./ ${{ secrets.ALIYUN_SSH_USER }}@${{ secrets.ALIYUN_ECS_HOST }}:${{ steps.create-release.outputs.RELEASE_DIR }}/

          echo "âœ… ä»£ç ä¸Šä¼ å®Œæˆ"

      # Step 6: å®‰è£…ä¾èµ–
      - name: Install dependencies on ECS
        run: |
          ssh ${{ secrets.ALIYUN_SSH_USER }}@${{ secrets.ALIYUN_ECS_HOST }} << 'EOF'
            cd ${{ steps.create-release.outputs.RELEASE_DIR }}

            # å®‰è£…ä¾èµ–
            /home/${{ secrets.ALIYUN_SSH_USER }}/.local/bin/uv sync --frozen

            echo "âœ… ä¾èµ–å®‰è£…å®Œæˆ"
          EOF

      # Step 7: æ›´æ–° systemd æœåŠ¡æ–‡ä»¶
      - name: Update systemd service file
        run: |
          ssh ${{ secrets.ALIYUN_SSH_USER }}@${{ secrets.ALIYUN_ECS_HOST }} << 'EOF'
            # å¤åˆ¶æœåŠ¡æ–‡ä»¶åˆ°ç³»ç»Ÿç›®å½•
            sudo cp ${{ steps.create-release.outputs.RELEASE_DIR }}/deploy/diting.service /etc/systemd/system/diting.service

            # é‡æ–°åŠ è½½ systemd é…ç½®
            sudo systemctl daemon-reload

            echo "âœ… Systemd æœåŠ¡æ–‡ä»¶å·²æ›´æ–°"
          EOF

      # Step 8: åŸå­æ€§æ¿€æ´»æ–°ç‰ˆæœ¬
      - name: Activate new release
        run: |
          ssh ${{ secrets.ALIYUN_SSH_USER }}@${{ secrets.ALIYUN_ECS_HOST }} << 'EOF'
            # ä¿å­˜å½“å‰ç‰ˆæœ¬ä¸º previous(ç”¨äºå›æ»š)
            if [ -L /opt/diting/current ]; then
              CURRENT_TARGET=$(readlink /opt/diting/current)
              ln -sfn "$CURRENT_TARGET" /opt/diting/previous
            fi

            # åˆ‡æ¢åˆ°æ–°ç‰ˆæœ¬
            ln -sfn ${{ steps.create-release.outputs.RELEASE_DIR }} /opt/diting/current

            echo "âœ… æ–°ç‰ˆæœ¬å·²æ¿€æ´»"
          EOF

      # Step 9: é‡å¯æœåŠ¡
      - name: Restart service
        run: |
          ssh ${{ secrets.ALIYUN_SSH_USER }}@${{ secrets.ALIYUN_ECS_HOST }} \
            "sudo systemctl restart diting"

          echo "âœ… æœåŠ¡å·²é‡å¯"

      # Step 10: å¥åº·æ£€æŸ¥
      - name: Health check
        id: health-check
        run: |
          ssh ${{ secrets.ALIYUN_SSH_USER }}@${{ secrets.ALIYUN_ECS_HOST }} << 'EOF'
            # ç­‰å¾…æœåŠ¡å¯åŠ¨(æœ€å¤š 60 ç§’)
            for i in {1..60}; do
              if systemctl is-active --quiet diting; then
                echo "âœ… æœåŠ¡å·²å¯åŠ¨"
                break
              fi
              echo "â³ ç­‰å¾…æœåŠ¡å¯åŠ¨... ($i/60)"
              sleep 1
            done

            # HTTP å¥åº·æ£€æŸ¥
            for i in {1..30}; do
              if curl -f http://localhost:8000/health > /dev/null 2>&1; then
                echo "âœ… å¥åº·æ£€æŸ¥é€šè¿‡"

                # éªŒè¯ JSON å“åº”æ ¼å¼
                HEALTH_RESPONSE=$(curl -s http://localhost:8000/health)
                if echo "$HEALTH_RESPONSE" | jq -e '.status == "healthy"' > /dev/null 2>&1; then
                  echo "âœ… å¥åº·æ£€æŸ¥å“åº”æ ¼å¼æ­£ç¡®"
                  exit 0
                fi
              fi
              echo "â³ ç­‰å¾…å¥åº·æ£€æŸ¥... ($i/30)"
              sleep 1
            done

            echo "âŒ å¥åº·æ£€æŸ¥å¤±è´¥"
            exit 1
          EOF

      # Step 11: å›æ»š(ä»…åœ¨å¥åº·æ£€æŸ¥å¤±è´¥æ—¶)
      - name: Rollback on failure
        if: failure() && steps.health-check.outcome == 'failure'
        run: |
          ssh ${{ secrets.ALIYUN_SSH_USER }}@${{ secrets.ALIYUN_ECS_HOST }} << 'EOF'
            echo "âš ï¸  å¼€å§‹å›æ»š..."

            # æ¢å¤åˆ°ä¸Šä¸€ä¸ªç‰ˆæœ¬
            if [ -L /opt/diting/previous ]; then
              PREVIOUS_TARGET=$(readlink /opt/diting/previous)
              ln -sfn "$PREVIOUS_TARGET" /opt/diting/current
              sudo systemctl restart diting

              echo "âœ… å·²å›æ»šåˆ°: $PREVIOUS_TARGET"
            else
              echo "âŒ æ— æ³•å›æ»š: previous ç¬¦å·é“¾æ¥ä¸å­˜åœ¨"
              exit 1
            fi
          EOF

      # Step 12: æ¸…ç†æ—§ç‰ˆæœ¬(ä¿ç•™æœ€è¿‘ 3 ä¸ª,æ¸…ç† 7 å¤©å‰çš„)
      - name: Cleanup old releases
        if: success()
        run: |
          ssh ${{ secrets.ALIYUN_SSH_USER }}@${{ secrets.ALIYUN_ECS_HOST }} << 'EOF'
            cd /opt/diting/releases

            # ä¿ç•™æœ€è¿‘ 3 ä¸ªç‰ˆæœ¬
            KEEP_COUNT=3
            ls -t | tail -n +$((KEEP_COUNT + 1)) | xargs -r rm -rf

            # æ¸…ç† 7 å¤©å‰çš„ç‰ˆæœ¬
            find . -maxdepth 1 -type d -mtime +7 -exec rm -rf {} \;

            echo "âœ… æ¸…ç†å®Œæˆ"
          EOF

      # Step 13: éƒ¨ç½²æˆåŠŸæ€»ç»“
      - name: Deployment summary
        if: success()
        run: |
          echo "## ğŸ‰ éƒ¨ç½²æˆåŠŸ!"
          echo ""
          echo "- **ç‰ˆæœ¬**: ${{ steps.create-release.outputs.RELEASE_ID }}"
          echo "- **æäº¤**: ${{ github.sha }}"
          echo "- **ä½œè€…**: ${{ github.actor }}"
          echo "- **åˆ†æ”¯**: ${{ github.ref_name }}"
          echo "- **æ—¶é—´**: $(date -u +"%Y-%m-%dT%H:%M:%SZ")"

      # Step 14: åˆ›å»ºå¤±è´¥é€šçŸ¥ Issue
      - name: Create failure issue
        if: failure()
        uses: actions/github-script@v7
        with:
          script: |
            const deployUrl = `${context.payload.repository.html_url}/actions/runs/${context.runId}`;
            const body = `## âŒ éƒ¨ç½²å¤±è´¥

            **è¯¦æƒ…**:
            - **ç‰ˆæœ¬**: ${{ steps.create-release.outputs.RELEASE_ID || 'æœªåˆ›å»º' }}
            - **æäº¤**: ${{ github.sha }}
            - **ä½œè€…**: ${{ github.actor }}
            - **åˆ†æ”¯**: ${{ github.ref_name }}
            - **æ—¶é—´**: ${new Date().toISOString()}

            **æ—¥å¿—**: [æŸ¥çœ‹ Actions æ—¥å¿—](${deployUrl})

            **å¯èƒ½åŸå› **:
            - SSH è¿æ¥å¤±è´¥
            - ä¾èµ–å®‰è£…å¤±è´¥
            - æœåŠ¡å¯åŠ¨å¤±è´¥
            - å¥åº·æ£€æŸ¥è¶…æ—¶

            **åç»­æ­¥éª¤**:
            1. æŸ¥çœ‹ Actions æ—¥å¿—å®šä½é”™è¯¯
            2. æ£€æŸ¥ ECS æœåŠ¡å™¨çŠ¶æ€
            3. éªŒè¯ GitHub Secrets é…ç½®
            4. å¦‚æœå·²å›æ»š,ç¡®è®¤æœåŠ¡æ­£å¸¸è¿è¡Œ
            `;

            await github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: `[Deploy Failed] ${new Date().toISOString().split('T')[0]} - ${context.sha.substring(0, 7)}`,
              body: body,
              labels: ['deployment', 'bug']
            });

# é¢„æœŸç»“æœ:
# âœ… æˆåŠŸ: æ–°ç‰ˆæœ¬éƒ¨ç½²å¹¶é€šè¿‡å¥åº·æ£€æŸ¥,æ—§ç‰ˆæœ¬å·²æ¸…ç†
# âŒ å¤±è´¥: è‡ªåŠ¨å›æ»šåˆ°ä¸Šä¸€ä¸ªç‰ˆæœ¬,æœåŠ¡ä¿æŒå¯ç”¨,åˆ›å»º Issue é€šçŸ¥
# â±ï¸ é¢„æœŸæ—¶é—´: 5-10 åˆ†é’Ÿ
#
# æ‰€éœ€ GitHub Secrets:
# - ALIYUN_ECS_HOST: ECS æœåŠ¡å™¨ IP æˆ–åŸŸå
# - ALIYUN_SSH_USER: SSH ç”¨æˆ·å(å»ºè®®: deploy)
# - ALIYUN_SSH_PRIVATE_KEY: SSH ç§é’¥(ED25519 æ ¼å¼)
