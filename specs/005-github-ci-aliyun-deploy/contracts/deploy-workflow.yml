name: Deploy to Aliyun ECS

# è§¦å‘æ¡ä»¶: ä»… master åˆ†æ”¯çš„ push äº‹ä»¶
on:
  push:
    branches: [master]

# æƒé™é…ç½®
permissions:
  contents: read

jobs:
  deploy:
    runs-on: ubuntu-latest
    timeout-minutes: 15  # è¶…æ—¶ä¿æŠ¤
    environment:
      name: production
      url: http://${{ secrets.ALIYUN_ECS_HOST }}:8000

    steps:
      # Step 1: æ£€å‡ºä»£ç 
      - name: Checkout code
        uses: actions/checkout@v4

      # Step 2: é…ç½® SSH å¯†é’¥
      - name: Setup SSH key
        uses: webfactory/ssh-agent@v0.9.0
        with:
          ssh-private-key: ${{ secrets.ALIYUN_SSH_PRIVATE_KEY }}

      # Step 3: æ·»åŠ  ECS åˆ° known_hosts(é˜²æ­¢ä¸­é—´äººæ”»å‡»)
      - name: Add ECS to known hosts
        run: |
          mkdir -p ~/.ssh
          ssh-keyscan -H ${{ secrets.ALIYUN_ECS_HOST }} >> ~/.ssh/known_hosts

      # Step 4: åˆ›å»ºéƒ¨ç½²ç‰ˆæœ¬ç›®å½•
      - name: Create release directory
        id: create-release
        run: |
          RELEASE_ID=$(date +%s)
          RELEASE_DIR="/opt/diting/releases/$RELEASE_ID"
          echo "RELEASE_ID=$RELEASE_ID" >> $GITHUB_OUTPUT
          echo "RELEASE_DIR=$RELEASE_DIR" >> $GITHUB_OUTPUT

          ssh ${{ secrets.ALIYUN_SSH_USER }}@${{ secrets.ALIYUN_ECS_HOST }} \
            "mkdir -p $RELEASE_DIR"

          echo "âœ… åˆ›å»ºç‰ˆæœ¬ç›®å½•: $RELEASE_DIR"

      # Step 5: ä¸Šä¼ ä»£ç åˆ° ECS
      - name: Upload code to ECS
        run: |
          rsync -avz \
            --exclude='.git' \
            --exclude='.venv' \
            --exclude='__pycache__' \
            --exclude='*.pyc' \
            --exclude='.pytest_cache' \
            --exclude='.ruff_cache' \
            --exclude='.mypy_cache' \
            --exclude='coverage.xml' \
            --exclude='.coverage' \
            --exclude='logs/' \
            ./ ${{ secrets.ALIYUN_SSH_USER }}@${{ secrets.ALIYUN_ECS_HOST }}:${{ steps.create-release.outputs.RELEASE_DIR }}/

          echo "âœ… ä»£ç ä¸Šä¼ å®Œæˆ"

      # Step 6: å®‰è£…ä¾èµ–
      - name: Install dependencies on ECS
        run: |
          ssh ${{ secrets.ALIYUN_SSH_USER }}@${{ secrets.ALIYUN_ECS_HOST }} << 'EOF'
            cd ${{ steps.create-release.outputs.RELEASE_DIR }}

            # å®‰è£…ä¾èµ–
            /home/${{ secrets.ALIYUN_SSH_USER }}/.local/bin/uv sync --frozen

            echo "âœ… ä¾èµ–å®‰è£…å®Œæˆ"
          EOF

      # Step 7: åŸå­æ€§æ¿€æ´»æ–°ç‰ˆæœ¬
      - name: Activate new release
        run: |
          ssh ${{ secrets.ALIYUN_SSH_USER }}@${{ secrets.ALIYUN_ECS_HOST }} << 'EOF'
            # ä¿å­˜å½“å‰ç‰ˆæœ¬ä¸º previous(ç”¨äºå›æ»š)
            if [ -L /opt/diting/current ]; then
              CURRENT_TARGET=$(readlink /opt/diting/current)
              ln -sfn "$CURRENT_TARGET" /opt/diting/previous
            fi

            # åˆ‡æ¢åˆ°æ–°ç‰ˆæœ¬
            ln -sfn ${{ steps.create-release.outputs.RELEASE_DIR }} /opt/diting/current

            echo "âœ… æ–°ç‰ˆæœ¬å·²æ¿€æ´»"
          EOF

      # Step 8: é‡å¯æœåŠ¡
      - name: Restart service
        run: |
          ssh ${{ secrets.ALIYUN_SSH_USER }}@${{ secrets.ALIYUN_ECS_HOST }} \
            "sudo systemctl restart diting"

          echo "âœ… æœåŠ¡å·²é‡å¯"

      # Step 9: å¥åº·æ£€æŸ¥
      - name: Health check
        id: health-check
        run: |
          ssh ${{ secrets.ALIYUN_SSH_USER }}@${{ secrets.ALIYUN_ECS_HOST }} << 'EOF'
            # ç­‰å¾…æœåŠ¡å¯åŠ¨(æœ€å¤š 60 ç§’)
            for i in {1..60}; do
              if systemctl is-active --quiet diting; then
                echo "âœ… æœåŠ¡å·²å¯åŠ¨"
                break
              fi
              echo "â³ ç­‰å¾…æœåŠ¡å¯åŠ¨... ($i/60)"
              sleep 1
            done

            # HTTP å¥åº·æ£€æŸ¥
            for i in {1..30}; do
              if curl -f http://localhost:8000/health > /dev/null 2>&1; then
                echo "âœ… å¥åº·æ£€æŸ¥é€šè¿‡"
                exit 0
              fi
              echo "â³ ç­‰å¾…å¥åº·æ£€æŸ¥... ($i/30)"
              sleep 1
            done

            echo "âŒ å¥åº·æ£€æŸ¥å¤±è´¥"
            exit 1
          EOF

      # Step 10: å›æ»š(ä»…åœ¨å¥åº·æ£€æŸ¥å¤±è´¥æ—¶)
      - name: Rollback on failure
        if: failure() && steps.health-check.outcome == 'failure'
        run: |
          ssh ${{ secrets.ALIYUN_SSH_USER }}@${{ secrets.ALIYUN_ECS_HOST }} << 'EOF'
            echo "âš ï¸  å¼€å§‹å›æ»š..."

            # æ¢å¤åˆ°ä¸Šä¸€ä¸ªç‰ˆæœ¬
            if [ -L /opt/diting/previous ]; then
              PREVIOUS_TARGET=$(readlink /opt/diting/previous)
              ln -sfn "$PREVIOUS_TARGET" /opt/diting/current
              sudo systemctl restart diting

              echo "âœ… å·²å›æ»šåˆ°: $PREVIOUS_TARGET"
            else
              echo "âŒ æ— æ³•å›æ»š: previous ç¬¦å·é“¾æ¥ä¸å­˜åœ¨"
              exit 1
            fi
          EOF

      # Step 11: æ¸…ç†æ—§ç‰ˆæœ¬(ä¿ç•™æœ€è¿‘ 3 ä¸ª)
      - name: Cleanup old releases
        if: success()
        run: |
          ssh ${{ secrets.ALIYUN_SSH_USER }}@${{ secrets.ALIYUN_ECS_HOST }} << 'EOF'
            cd /opt/diting/releases

            # ä¿ç•™æœ€è¿‘ 3 ä¸ªç‰ˆæœ¬
            ls -t | tail -n +4 | xargs -r rm -rf

            echo "âœ… æ¸…ç†å®Œæˆ"
          EOF

      # Step 12: éƒ¨ç½²æˆåŠŸé€šçŸ¥
      - name: Notify deployment success
        if: success()
        run: |
          echo "ğŸ‰ éƒ¨ç½²æˆåŠŸ!"
          echo "ç‰ˆæœ¬: ${{ steps.create-release.outputs.RELEASE_ID }}"
          echo "æäº¤: ${{ github.sha }}"
          echo "ä½œè€…: ${{ github.actor }}"

# é¢„æœŸç»“æœ:
# âœ… æˆåŠŸ: æ–°ç‰ˆæœ¬éƒ¨ç½²å¹¶é€šè¿‡å¥åº·æ£€æŸ¥,æ—§ç‰ˆæœ¬å·²æ¸…ç†
# âŒ å¤±è´¥: è‡ªåŠ¨å›æ»šåˆ°ä¸Šä¸€ä¸ªç‰ˆæœ¬,æœåŠ¡ä¿æŒå¯ç”¨
# â±ï¸ é¢„æœŸæ—¶é—´: 5-10 åˆ†é’Ÿ

# æ‰€éœ€ GitHub Secrets:
# - ALIYUN_ECS_HOST: ECS æœåŠ¡å™¨ IP æˆ–åŸŸå
# - ALIYUN_SSH_USER: SSH ç”¨æˆ·å(å»ºè®®: deploy)
# - ALIYUN_SSH_PRIVATE_KEY: SSH ç§é’¥(ED25519 æ ¼å¼)
