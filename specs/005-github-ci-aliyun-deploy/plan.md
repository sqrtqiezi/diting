# Implementation Plan: GitHub CI/CD ä¸é˜¿é‡Œäº‘ ECS éƒ¨ç½²

**Branch**: `005-github-ci-aliyun-deploy` | **Date**: 2025-11-02 | **Spec**: [spec.md](./spec.md)
**Input**: Feature specification from `/specs/005-github-ci-aliyun-deploy/spec.md`

## Summary

å®ç°åŸºäº GitHub Actions çš„è‡ªåŠ¨åŒ–æµ‹è¯•å’Œéƒ¨ç½²æµç¨‹,å½“ä»£ç æ¨é€æ—¶è‡ªåŠ¨è¿è¡Œè´¨é‡æ£€æŸ¥å’Œæµ‹è¯•,å½“åˆå¹¶åˆ° master åˆ†æ”¯æ—¶è‡ªåŠ¨éƒ¨ç½²åˆ°é˜¿é‡Œäº‘ ECS æœåŠ¡å™¨ã€‚

**æŠ€æœ¯æ–¹æ¡ˆ**:
- ä½¿ç”¨ GitHub Actions å®ç° CI/CD æµæ°´çº¿
- é€šè¿‡ SSH å’Œ rsync éƒ¨ç½²åˆ°é˜¿é‡Œäº‘ ECS
- åŸºäºç¬¦å·é“¾æ¥çš„é›¶åœæœºéƒ¨ç½²å’Œå›æ»š
- Systemd æœåŠ¡ç®¡ç†å’Œå¥åº·æ£€æŸ¥éªŒè¯

## Technical Context

**Language/Version**: Python 3.12.6(å·²å®‰è£…)+ YAML(GitHub Actions é…ç½®)+ Bash(éƒ¨ç½²è„šæœ¬)
**Primary Dependencies**: GitHub Actions, rsync, SSH, systemd, uv
**Storage**: æ–‡ä»¶ç³»ç»Ÿ(ç‰ˆæœ¬ç›®å½• /opt/diting/releases/)+ GitHub Actions å…ƒæ•°æ® + journald æ—¥å¿—
**Testing**: pytest(å•å…ƒ/é›†æˆæµ‹è¯•), ruff(ä»£ç æ£€æŸ¥), mypy(ç±»å‹æ£€æŸ¥)
**Target Platform**: Rocky Linux 9.6 on é˜¿é‡Œäº‘ ECS + GitHub Actions Runner(ubuntu-latest)
**Project Type**: Single project(DevOps åŸºç¡€è®¾æ–½,ä¸æ¶‰åŠåº”ç”¨ä»£ç ç»“æ„å˜æ›´)
**Performance Goals**:
- æµ‹è¯•åé¦ˆ < 5 åˆ†é’Ÿ
- éƒ¨ç½²å®Œæˆ < 10 åˆ†é’Ÿ
- å¥åº·æ£€æŸ¥å“åº” < 100ms
**Constraints**:
- å•æœåŠ¡å™¨éƒ¨ç½²(æ— è´Ÿè½½å‡è¡¡)
- é›¶åœæœºæ—¶é—´è¦æ±‚
- GitHub Actions å…è´¹é¢åº¦é™åˆ¶(2000 åˆ†é’Ÿ/æœˆ)
**Scale/Scope**:
- 1 ä¸ªç”Ÿäº§ç¯å¢ƒ
- ä¿ç•™æœ€è¿‘ 3 ä¸ªéƒ¨ç½²ç‰ˆæœ¬
- æ”¯æŒå½“å‰é¡¹ç›®è§„æ¨¡(å°å‹å¾®æœåŠ¡)
**Deployment Configuration**:
- ECS ä¸»æœº: <é…ç½®åœ¨ ~/.ssh/config çš„ diting-server>
- SSH ç”¨æˆ·: deploy
- SSH å¯†é’¥: ~/keys/deploy.pem
- éƒ¨ç½²ç›®å½•: /opt/diting/releases/
- æœåŠ¡ç®¡ç†: systemd (diting.service)

## Constitution Check

*GATE: Must pass before Phase 0 research. Re-check after Phase 1 design.*

**çŠ¶æ€**: âœ… PASSED

**å®ªæ³•æ–‡ä»¶**: `.specify/memory/constitution.md` (v1.0.0)

### æ ¸å¿ƒåŸåˆ™ç¬¦åˆæ€§æ£€æŸ¥

| åŸåˆ™ | ç›¸å…³æ€§ | ç¬¦åˆçŠ¶æ€ | è¯´æ˜ |
|------|--------|----------|------|
| **I. Privacy First** | âšª æ— å…³ | âœ… N/A | CI/CD åŸºç¡€è®¾æ–½ä¸æ¶‰åŠç”¨æˆ·éšç§æ•°æ®å¤„ç† |
| **II. Endpoint Modularity** | âšª æ— å…³ | âœ… N/A | ä¸æ¶‰åŠæ•°æ®æºç«¯ç‚¹å¼€å‘ |
| **III. Knowledge Graph Core** | âšª æ— å…³ | âœ… N/A | ä¸æ¶‰åŠçŸ¥è¯†å›¾è°±åŠŸèƒ½ |
| **IV. LLM-Powered Insights** | âšª æ— å…³ | âœ… N/A | ä¸æ¶‰åŠ LLM åŠŸèƒ½ |
| **V. Observability & Testability** | ğŸŸ¢ é«˜åº¦ç›¸å…³ | âœ… ç¬¦åˆ | CI/CD æµç¨‹å¢å¼ºäº†ç³»ç»Ÿå¯è§‚æµ‹æ€§å’Œå¯æµ‹è¯•æ€§ |

### å®‰å…¨ä¸éšç§è¦æ±‚ç¬¦åˆæ€§

| è¦æ±‚ | ç›¸å…³æ€§ | ç¬¦åˆçŠ¶æ€ | å®æ–½æ–¹å¼ |
|------|--------|----------|----------|
| **æ•°æ®å®‰å…¨ - å¯†é’¥ç®¡ç†** | ğŸŸ¢ é«˜åº¦ç›¸å…³ | âœ… ç¬¦åˆ | ä½¿ç”¨ GitHub Secrets å®‰å…¨å­˜å‚¨ SSH å¯†é’¥å’Œå‡­è¯ |
| **API å®‰å…¨ - è®¿é—®æ§åˆ¶** | ğŸŸ¢ ç›¸å…³ | âœ… ç¬¦åˆ | SSH å¯†é’¥è®¤è¯ + sudo æƒé™é™åˆ¶ |
| **å®‰å…¨å®¡è®¡** | ğŸŸ¢ ç›¸å…³ | âœ… ç¬¦åˆ | GitHub Actions æ—¥å¿— + journald å®¡è®¡æ—¥å¿— |

### å¯è§‚æµ‹æ€§ä¸æµ‹è¯•è¦æ±‚ç¬¦åˆæ€§

æ­¤åŠŸèƒ½**ç›´æ¥æ”¯æŒ**å®ªæ³•ç¬¬ V æ¡åŸåˆ™:

- âœ… **ç»“æ„åŒ–æ—¥å¿—**: GitHub Actions è¾“å‡ºç»“æ„åŒ–æ—¥å¿—,systemd ä½¿ç”¨ journald
- âœ… **æ€§èƒ½ç›‘æ§**: ç›‘æ§æµ‹è¯•æ‰§è¡Œæ—¶é—´ã€éƒ¨ç½²æ—¶é•¿
- âœ… **é”™è¯¯è¿½è¸ª**: è¯¦ç»†çš„ CI/CD å¤±è´¥æ—¥å¿—å’Œå †æ ˆä¿¡æ¯
- âœ… **æµ‹è¯•è¦†ç›–**:
  - å•å…ƒæµ‹è¯•: é€šè¿‡ pytest å¼ºåˆ¶æ‰§è¡Œ
  - é›†æˆæµ‹è¯•: éƒ¨ç½²åå¥åº·æ£€æŸ¥
  - å¥‘çº¦æµ‹è¯•: API ç«¯ç‚¹å¥‘çº¦éªŒè¯
- âœ… **æœ¬åœ°è°ƒè¯•**: æ”¯æŒæœ¬åœ°è¿è¡Œ GitHub Actions å·¥ä½œæµ(ä½¿ç”¨ act)
- âœ… **è‡ªåŠ¨åŒ–æ£€æŸ¥**: è‡ªåŠ¨åŒ–ä»£ç è´¨é‡å’Œå®‰å…¨æ£€æŸ¥

### æŠ€æœ¯æ ‡å‡†ç¬¦åˆæ€§

è™½ç„¶æ­¤åŠŸèƒ½æ˜¯ DevOps åŸºç¡€è®¾æ–½,ä¸ç›´æ¥é€‚ç”¨ REST API å®¢æˆ·ç«¯æ ‡å‡†,ä½†éµå¾ªç›¸åŒçš„è´¨é‡è¦æ±‚:

- âœ… **æµ‹è¯•è¦†ç›–ç‡ â‰¥80%**: CI å¼ºåˆ¶æ‰§è¡Œè¦†ç›–ç‡æ£€æŸ¥
- âœ… **å®‰å…¨é…ç½®**: GitHub Secrets é˜²æ­¢å‡­è¯æ³„éœ²
- âœ… **æ€§èƒ½æ ‡å‡†**: æµ‹è¯• < 5 åˆ†é’Ÿ,éƒ¨ç½² < 10 åˆ†é’Ÿ

### ç»“è®º

æ­¤åŠŸèƒ½å®Œå…¨ç¬¦åˆå®ªæ³•è¦æ±‚,ä¸”é€šè¿‡è‡ªåŠ¨åŒ–æµ‹è¯•å’Œéƒ¨ç½²,**ç§¯æå¢å¼º**äº†ç³»ç»Ÿçš„å¯è§‚æµ‹æ€§å’Œå¯æµ‹è¯•æ€§(å®ªæ³•ç¬¬ V æ¡æ ¸å¿ƒåŸåˆ™)ã€‚æ— éœ€å¤æ‚åº¦è±å…ã€‚

## Project Structure

### Documentation (this feature)

```text
specs/005-github-ci-aliyun-deploy/
â”œâ”€â”€ spec.md              # åŠŸèƒ½è§„èŒƒ(å·²å®Œæˆ)
â”œâ”€â”€ plan.md              # æœ¬æ–‡ä»¶ - å®æ–½è®¡åˆ’
â”œâ”€â”€ research.md          # æŠ€æœ¯ç ”ç©¶å’Œé€‰å‹(å·²å®Œæˆ)
â”œâ”€â”€ data-model.md        # CI/CD æ•°æ®æ¨¡å‹(å·²å®Œæˆ)
â”œâ”€â”€ quickstart.md        # å¿«é€Ÿä¸Šæ‰‹æŒ‡å—(å·²å®Œæˆ)
â”œâ”€â”€ contracts/           # æ¥å£å¥‘çº¦(å·²å®Œæˆ)
â”‚   â”œâ”€â”€ README.md
â”‚   â”œâ”€â”€ test-workflow.yml
â”‚   â”œâ”€â”€ deploy-workflow.yml
â”‚   â”œâ”€â”€ systemd-service.service
â”‚   â””â”€â”€ health-endpoint.md
â””â”€â”€ tasks.md             # ä»»åŠ¡åˆ†è§£(å¾…ç”Ÿæˆ,ä½¿ç”¨ /speckit.tasks)
```

### Source Code (repository root)

æ­¤åŠŸèƒ½ä¸»è¦æ¶‰åŠ **DevOps é…ç½®æ–‡ä»¶**,ä¸ä¿®æ”¹ç°æœ‰åº”ç”¨ä»£ç ç»“æ„ã€‚

```text
.github/
â””â”€â”€ workflows/          # æ–°å¢ - GitHub Actions å·¥ä½œæµ
    â”œâ”€â”€ test.yml        # è‡ªåŠ¨åŒ–æµ‹è¯•å·¥ä½œæµ
    â””â”€â”€ deploy.yml      # è‡ªåŠ¨åŒ–éƒ¨ç½²å·¥ä½œæµ

src/
â”œâ”€â”€ endpoints/
â”‚   â””â”€â”€ wechat/
â”‚       â””â”€â”€ webhook_app.py  # éœ€è¦æ·»åŠ  /health ç«¯ç‚¹
â”œâ”€â”€ models/             # ç°æœ‰,æ— å˜æ›´
â”œâ”€â”€ services/           # ç°æœ‰,æ— å˜æ›´
â””â”€â”€ cli/                # ç°æœ‰,æ— å˜æ›´

tests/
â”œâ”€â”€ unit/
â”‚   â””â”€â”€ endpoints/
â”‚       â””â”€â”€ wechat/
â”‚           â””â”€â”€ test_health.py  # æ–°å¢ - å¥åº·æ£€æŸ¥æµ‹è¯•
â”œâ”€â”€ integration/        # ç°æœ‰,æ— å˜æ›´
â””â”€â”€ contract/           # ç°æœ‰,æ— å˜æ›´

deploy/                 # æ–°å¢ - éƒ¨ç½²ç›¸å…³æ–‡ä»¶(å¯é€‰)
â””â”€â”€ diting.service      # Systemd æœåŠ¡æ–‡ä»¶(å‚è€ƒ,å®é™…éƒ¨ç½²åˆ°æœåŠ¡å™¨)
```

**Structure Decision**: é€‰æ‹© Option 1 (Single project),å› ä¸ºè¿™æ˜¯ DevOps åŸºç¡€è®¾æ–½åŠŸèƒ½,ä¸æ”¹å˜åº”ç”¨ç¨‹åºæ¶æ„ã€‚ä¸»è¦å˜æ›´:
1. æ·»åŠ  `.github/workflows/` ç›®å½•å­˜æ”¾ CI/CD é…ç½®
2. åœ¨ç°æœ‰ `webhook_app.py` ä¸­æ·»åŠ  `/health` ç«¯ç‚¹
3. æ·»åŠ å¥åº·æ£€æŸ¥æµ‹è¯•ç”¨ä¾‹

**ä¸æ¶‰åŠçš„ç›®å½•**:
- æ— éœ€åˆ›å»ºæ–°çš„æœåŠ¡æˆ–æ¨¡å‹
- æ— éœ€ä¿®æ”¹ç°æœ‰ä¸šåŠ¡é€»è¾‘
- æ— éœ€æ·»åŠ æ•°æ®åº“è¿ç§»

## Complexity Tracking

**æ— å¤æ‚åº¦è¿è§„** - æ­¤éƒ¨åˆ†ä¸é€‚ç”¨

æ­¤åŠŸèƒ½æ˜¯ DevOps åŸºç¡€è®¾æ–½,ä¸å¢åŠ åº”ç”¨ç¨‹åºå¤æ‚åº¦ã€‚æ‰€æœ‰å˜æ›´éƒ½æ˜¯æ ‡å‡†çš„ CI/CD æœ€ä½³å®è·µã€‚

## Implementation Phases

### Phase 0: æŠ€æœ¯ç ”ç©¶ âœ… å·²å®Œæˆ

**è¾“å‡º**: [research.md](./research.md)

**å…³é”®å†³ç­–**:
- CI/CD å¹³å°: GitHub Actions
- éƒ¨ç½²æ–¹å¼: SSH + Systemd
- å¥åº·æ£€æŸ¥: HTTP /health ç«¯ç‚¹
- å›æ»šç­–ç•¥: ç¬¦å·é“¾æ¥åˆ‡æ¢

### Phase 1: è®¾è®¡æ–‡æ¡£ âœ… å·²å®Œæˆ

**è¾“å‡º**:
- [data-model.md](./data-model.md) - CI/CD æ•°æ®å®ä½“
- [contracts/](./contracts/) - Workflow å’Œ API å¥‘çº¦
- [quickstart.md](./quickstart.md) - å¿«é€Ÿä¸Šæ‰‹æŒ‡å—

**å…³é”®è®¾è®¡**:
- Workflow æ–‡ä»¶æ ¼å¼å’Œè§¦å‘æ¡ä»¶
- Systemd æœåŠ¡é…ç½®
- å¥åº·æ£€æŸ¥ç«¯ç‚¹è§„èŒƒ
- ç‰ˆæœ¬ç®¡ç†ç­–ç•¥

### Phase 2: ä»»åŠ¡åˆ†è§£ â³ å¾…æ‰§è¡Œ

**å‘½ä»¤**: `/speckit.tasks`

**é¢„æœŸè¾“å‡º**: [tasks.md](./tasks.md)

**ä»»åŠ¡ç±»å‹**:
1. **ä»£ç å®ç°**: æ·»åŠ  /health ç«¯ç‚¹å’Œæµ‹è¯•
2. **é…ç½®æ–‡ä»¶**: åˆ›å»º workflow æ–‡ä»¶
3. **æœåŠ¡å™¨å‡†å¤‡**: é…ç½® ECS ç¯å¢ƒ
4. **éªŒè¯æµ‹è¯•**: ç«¯åˆ°ç«¯æµ‹è¯• CI/CD æµç¨‹

### Phase 3: å®æ–½æ‰§è¡Œ â³ å¾…æ‰§è¡Œ

**å‘½ä»¤**: `/speckit.implement`

**æ‰§è¡Œé¡ºåº**:
1. æœ¬åœ°å¼€å‘å’Œæµ‹è¯•(User Story 1 ç›¸å…³)
2. ECS æœåŠ¡å™¨é…ç½®(User Story 2 å‰ç½®æ¡ä»¶)
3. GitHub é…ç½®(Secrets, Workflows)
4. é¦–æ¬¡éƒ¨ç½²éªŒè¯
5. å®Œæ•´æµç¨‹æµ‹è¯•

## Next Steps

1. **ç”Ÿæˆä»»åŠ¡åˆ—è¡¨**:
   ```bash
   /speckit.tasks
   ```

2. **å¼€å§‹å®æ–½**:
   ```bash
   /speckit.implement
   ```

3. **æŒç»­è·Ÿè¸ª**:
   - ä½¿ç”¨ GitHub Projects è·Ÿè¸ªä»»åŠ¡è¿›åº¦
   - ä½¿ç”¨ GitHub Actions æŸ¥çœ‹ CI/CD è¿è¡Œå†å²
   - ä½¿ç”¨ journald ç›‘æ§æœåŠ¡å™¨æ—¥å¿—

## Related Documentation

- **Specification**: [spec.md](./spec.md) - åŠŸèƒ½éœ€æ±‚å’Œç”¨æˆ·æ•…äº‹
- **Research**: [research.md](./research.md) - æŠ€æœ¯é€‰å‹å’Œå¯è¡Œæ€§åˆ†æ
- **Data Model**: [data-model.md](./data-model.md) - CI/CD æ•°æ®å®ä½“è®¾è®¡
- **Contracts**: [contracts/](./contracts/) - Workflow å’Œ API å¥‘çº¦
- **Quickstart**: [quickstart.md](./quickstart.md) - å¿«é€Ÿä¸Šæ‰‹æŒ‡å—
- **Tasks**: [tasks.md](./tasks.md) - ä»»åŠ¡åˆ†è§£(å¾…ç”Ÿæˆ)

## Success Validation

å®Œæˆå®æ–½å,éªŒè¯ä»¥ä¸‹æˆåŠŸæ ‡å‡†:

- [ ] **SC-001**: æ¨é€ä»£ç å 5 åˆ†é’Ÿå†…æ”¶åˆ°æµ‹è¯•ç»“æœ
- [ ] **SC-002**: æµ‹è¯•å¤±è´¥çš„ä»£ç æ— æ³•åˆå¹¶åˆ° master
- [ ] **SC-003**: master åˆå¹¶å 10 åˆ†é’Ÿå†…å®Œæˆéƒ¨ç½²
- [ ] **SC-004**: éƒ¨ç½²æˆåŠŸç‡ > 95%
- [ ] **SC-005**: å¸¸è§„å‘å¸ƒæ— éœ€ä»»ä½•æ‰‹åŠ¨æ­¥éª¤
- [ ] **SC-006**: å¤±è´¥éƒ¨ç½²è‡ªåŠ¨å›æ»š,é›¶åœæœº
- [ ] **SC-007**: 30 ç§’å†…å¯ä»¥è¯†åˆ«éƒ¨ç½²çŠ¶æ€
- [ ] **SC-008**: æ— å‡­è¯æ³„éœ²(æ‰«æä»“åº“å’Œæ—¥å¿—)
- [ ] **SC-009**: ä»£ç æµ‹è¯•è¦†ç›–ç‡ â‰¥ 80%(å®ªæ³•è¦æ±‚)
